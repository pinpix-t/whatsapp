# Redis Production Configuration
# WhatsApp Bot - Optimized for session storage and caching

# Network Configuration
bind 0.0.0.0
protected-mode yes
port 6379
tcp-backlog 511
timeout 300
tcp-keepalive 300

# Security - IMPORTANT: Set password via environment variable
# requirepass YOUR_STRONG_PASSWORD_HERE
# Password should be set via REDIS_PASSWORD environment variable

# Memory Management
maxmemory 512mb
maxmemory-policy allkeys-lru  # Evict least recently used keys when memory limit reached
maxmemory-samples 5

# Persistence Configuration
# RDB Snapshots
save 900 1      # Save after 900 seconds if at least 1 key changed
save 300 10     # Save after 300 seconds if at least 10 keys changed
save 60 10000   # Save after 60 seconds if at least 10000 keys changed
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# AOF (Append Only File) - More durable persistence
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec  # Sync every second (good balance of performance/durability)
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# Performance Tuning
# Slow log configuration
slowlog-log-slower-than 10000  # Log queries slower than 10ms
slowlog-max-len 128

# Connection Management
maxclients 10000

# Lazy Freeing (non-blocking delete)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Threading (Redis 6.0+)
io-threads 4
io-threads-do-reads yes

# Logging
loglevel notice
logfile ""  # Log to stdout (Docker will capture)
syslog-enabled no

# Advanced Configuration
databases 16
always-show-logo yes
set-proc-title yes
proc-title-template "{title} {listen-addr} {server-mode}"

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
rename-command SHUTDOWN ""
rename-command DEBUG ""

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Frequency of rehashing the main hash table (1-100)
hz 10

# Enable active rehashing
activerehashing yes

# Jemalloc configuration
jemalloc-bg-thread yes

# Defragmentation (Redis 4.0+)
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 20
active-defrag-cycle-min 5
active-defrag-cycle-max 75
